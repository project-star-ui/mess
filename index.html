<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Messmisan Messenger</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    :root {
      --primary-color: #8e44ad; /* Dark Lavender */
      --secondary-color: #6c7a89; /* Semi-gray */
      --accent-color: #9b59b6; /* Lighter lavender accent */
      --background-dark: #111; /* Dark background */
      --background-light: #1e1e1e; /* Slightly lighter background */
      --text-color: #ecf0f1;
      --input-bg: #2c3e50;
      --border-color: #34495e;
      --bubble-sent: #9b59b6; /* Lavender for sent */
      --bubble-received: #34495e; /* Dark gray-blue for received */
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: var(--background-dark);
      color: var(--text-color);
      width: 100vw;
      height: 100vh;
      overflow: hidden;
    }
    .main {
      display: flex;
      width: 100%;
      height: 100%;
      background-color: var(--background-dark);
      position: relative;
    }
    .sidebar {
      width: 280px; /* Slightly wider */
      background-color: var(--background-light);
      display: flex;
      flex-direction: column;
      padding: 20px;
      border-right: 1px solid var(--border-color);
      transition: transform 0.3s ease-in-out;
      flex-shrink: 0; /* Prevent shrinking */
    }
    .sidebar {
      transform: translateX(-100%);
      transition: transform 0.3s ease;
    }
    .sidebar.visible {
      transform: translateX(0);
    }
    .sidebar h2 {
      font-size: 1.8rem; /* Larger font */
      margin-bottom: 25px;
      color: var(--accent-color); /* Teal for headings */
      text-align: center;
      text-shadow: 1px 1px 3px rgba(0,0,0,0.3);
    }
    .sidebar input, .sidebar button {
      margin-bottom: 12px; /* More spacing */
      padding: 12px;
      border-radius: 10px; /* More rounded */
      border: none;
      background: var(--input-bg);
      color: var(--text-color);
      font-size: 1rem;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
    }
    .sidebar input::placeholder {
      color: rgba(255,255,255,0.6);
    }
    .sidebar button {
      background-color: var(--primary-color);
      color: var(--text-color);
      cursor: pointer;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: background-color 0.2s ease, transform 0.1s ease;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }
    .sidebar button:hover {
      background-color: var(--accent-color);
      transform: translateY(-1px);
    }
    .sidebar button:active {
      transform: translateY(0);
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    .friends {
      flex: 1;
      overflow-y: auto;
      margin-top: 15px;
      padding-right: 5px; /* For scrollbar */
    }
    .friends::-webkit-scrollbar {
      width: 8px;
    }
    .friends::-webkit-scrollbar-track {
      background: var(--background-dark);
      border-radius: 10px;
    }
    .friends::-webkit-scrollbar-thumb {
      background: var(--primary-color);
      border-radius: 10px;
    }
    .friends::-webkit-scrollbar-thumb:hover {
      background: var(--secondary-color);
    }

    .friend {
      background-color: var(--input-bg);
      padding: 12px;
      margin-bottom: 8px;
      border-radius: 10px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: background-color 0.2s ease, transform 0.1s ease;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    .friend:hover {
      background-color: var(--border-color);
      transform: translateX(3px);
    }
    .friend i {
      color: var(--accent-color);
      font-size: 1.2rem;
    }

    .chat-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      position: relative;
      background-color: var(--background-dark);
    }
    .chat-header {
      background-color: var(--background-light);
      padding: 16px 20px;
      font-size: 1.2rem;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }
    .hamburger {
      display: none; /* Hidden by default on desktop */
      font-size: 28px; /* Larger icon */
      cursor: pointer;
      color: var(--accent-color);
      transition: color 0.2s ease;
    }
    .hamburger:hover {
      color: var(--secondary-color);
    }
    .chat-header span {
      flex: 1;
      text-align: center;
      font-weight: bold;
      color: var(--accent-color);
    }
    .messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px; /* Space between bubbles */
    }
    .messages::-webkit-scrollbar {
      width: 8px;
    }
    .messages::-webkit-scrollbar-track {
      background: var(--background-dark);
      border-radius: 10px;
    }
    .messages::-webkit-scrollbar-thumb {
      background: var(--primary-color);
      border-radius: 10px;
    }
    .messages::-webkit-scrollbar-thumb:hover {
      background: var(--secondary-color);
    }

    .bubble {
      max-width: 70%; /* Slightly wider bubbles */
      padding: 12px 18px;
      border-radius: 25px 25px 25px 5px; /* Cute, blob-like shape */
      line-height: 1.5;
      word-wrap: break-word;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      position: relative;
    }
    .sent {
      align-self: flex-end;
      background-color: var(--bubble-sent);
      color: var(--text-color);
      border-radius: 25px 25px 5px 25px;
    }
    .received {
      align-self: flex-start;
      background-color: var(--bubble-received);
      color: var(--text-color);
      border-radius: 25px 25px 25px 5px;
    }

    .message-input {
      display: flex;
      padding: 15px 20px;
      border-top: 1px solid var(--border-color);
      background-color: var(--background-light);
      gap: 10px;
      box-shadow: 0 -2px 5px rgba(0,0,0,0.3);
    }
    .message-input input {
      flex: 1;
      padding: 12px 18px;
      background: var(--input-bg);
      color: var(--text-color);
      border: none;
      border-radius: 25px; /* More rounded */
      font-size: 1rem;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
    }
    .message-input input::placeholder {
      color: rgba(255,255,255,0.6);
    }
    .message-input button {
      padding: 12px 20px;
      background-color: var(--primary-color);
      border: none;
      border-radius: 25px;
      color: var(--text-color);
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: background-color 0.2s ease, transform 0.1s ease;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }
    .message-input button:hover {
      background-color: var(--secondary-color);
      transform: translateY(-1px);
    }
    .message-input button:active {
      transform: translateY(0);
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }

    #chatUI { display: none; } /* Hidden by default */

    .auth-container {
      display: flex;
      flex-direction: column;
      padding: 40px;
      max-width: 450px; /* Slightly wider */
      margin: auto;
      background-color: var(--background-light);
      border-radius: 15px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.5);
      animation: fadeIn 0.5s ease-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .auth-container input, .auth-container button {
      margin-bottom: 15px; /* More spacing */
      padding: 14px;
      border-radius: 10px;
      border: none;
      font-size: 1.1rem;
      background: var(--input-bg);
      color: var(--text-color);
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
    }
    .auth-container input::placeholder {
      color: rgba(255,255,255,0.6);
    }
    .auth-container button {
      background-color: var(--primary-color);
      color: var(--text-color);
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      transition: background-color 0.2s ease, transform 0.1s ease;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }
    .auth-container button:hover {
      background-color: var(--secondary-color);
      transform: translateY(-1px);
    }
    .auth-container button:active {
      transform: translateY(0);
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    .auth-container h2 {
      text-align: center;
      color: var(--accent-color);
      margin-bottom: 30px;
      font-size: 2.2rem;
      text-shadow: 1px 1px 4px rgba(0,0,0,0.4);
    }
    .switch-link {
      text-align: center;
      margin-top: 15px;
      color: var(--accent-color);
      cursor: pointer;
      font-size: 1rem;
      transition: color 0.2s ease;
    }
    .switch-link:hover {
      color: var(--secondary-color);
      text-decoration: underline;
    }

    /* Mobile Responsiveness */
    @media (max-width: 768px) {
      body {
        overflow: auto;
        min-height: -webkit-fill-available;
      }
      .main {
        flex-direction: column;
        height: 100%;
      }
      .sidebar {
        position: fixed;
        z-index: 1000;
        height: 100%;
        width: 85%;
        max-width: 300px;
        transform: translateX(-100%);
        transition: transform 0.3s ease;
      }
      .sidebar.visible {
        transform: translateX(0);
      }
      .hamburger {
        display: flex;
        align-items: center;
        padding: 15px;
        font-size: 24px;
      }
      .chat-area {
        width: 100%;
        height: 100vh;
      }
      .chat-header {
        padding: 12px 15px;
      }
      .messages {
        padding: 10px;
        padding-bottom: 70px;
      }
      .message-input {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        padding: 10px;
      }
      .bubble {
        max-width: 85%;
      }
      .auth-container {
        width: 100%;
        max-width: none;
        margin: 20px auto;
        padding: 20px;
      }
    }
  </style>
</head>
<body>
  <div id="auth">
    <div id="loginForm" class="auth-container">
      <h2>Login to Messmisan</h2>
      <input id="loginEmail" type="email" placeholder="Email" />
      <input id="loginPassword" type="password" placeholder="Password" />
      <button onclick="login()"><i class="fas fa-sign-in-alt"></i> Log In</button>
      <div class="switch-link" onclick="toggleAuthForm()">Don't have an account? Sign up <i class="fas fa-user-plus"></i></div>
    </div>
    <div id="signupForm" class="auth-container" style="display:none;">
      <h2>Sign Up</h2>
      <input id="nickname" placeholder="Nickname" />
      <input id="email" type="email" placeholder="Email" />
      <input id="password" type="password" placeholder="Password" />
      <button onclick="signup()"><i class="fas fa-user-plus"></i> Sign Up</button>
      <div class="switch-link" onclick="toggleAuthForm()">Already have an account? Log in <i class="fas fa-sign-in-alt"></i></div>
    </div>
  </div>

  <div id="chatUI" class="main">
    <div class="sidebar" id="sidebar">
      <h2 id="userNickname">Welcome</h2>
      <button onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</button>
      <input id="friendEmail" placeholder="Add Friend by Email" />
      <button onclick="addFriend()"><i class="fas fa-user-plus"></i> Add Friend</button>
      <input id="searchEmail" placeholder="Search Friend to Chat" />
      <button onclick="searchFriend()"><i class="fas fa-search"></i> Start Chat</button>
      <div class="friends" id="friendList"></div>
    </div>
    <div class="chat-area">
      <div class="chat-header">
        <div class="hamburger" onclick="toggleSidebar()"><i class="fas fa-bars"></i></div>
        <span>Chatting with: <span id="chatWith">None</span></span>
      </div>
      <div class="messages" id="messages"></div>
      <div class="message-input">
        <input id="messageInput" placeholder="Type your message..." />
        <button onclick="sendMessage()"><i class="fas fa-paper-plane"></i> Send</button>
      </div>
    </div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
  import { getDatabase, ref, set, get, push, onChildAdded } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-database.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC1l66DhDXfAMOa2WPxocPWS_H3xGbTO_E",
    authDomain: "tracker-37839.firebaseapp.com",
    projectId: "tracker-37839",
    storageBucket: "tracker-37839.appspot.com",
    messagingSenderId: "569377443416",
    appId: "1:569377443416:web:cb67316b895567be75042d",
    databaseURL: "https://tracker-37839-default-rtdb.firebaseio.com"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth();

  let currentUser = null;
  let currentChatUID = null;

  window.toggleAuthForm = function () {
    const login = document.getElementById("loginForm");
    const signup = document.getElementById("signupForm");
    login.style.display = login.style.display === "none" ? "flex" : "none";
    signup.style.display = signup.style.display === "none" ? "flex" : "none";
  };

  window.toggleSidebar = function () {
    const sidebar = document.getElementById("sidebar");
    sidebar.classList.toggle("visible");
  };

  window.signup = function () {
    const nickname = document.getElementById("nickname").value.trim();
    const email = document.getElementById("email").value.trim();
    const password = document.getElementById("password").value.trim();
    if (!nickname || !email || !password) return alert("Please fill in all fields.");
    createUserWithEmailAndPassword(auth, email, password)
      .then(userCred => {
        const uid = userCred.user.uid;
        set(ref(db, 'users/' + uid), { nickname, email });
        alert("Signup successful! Please log in.");
        toggleAuthForm();
      })
      .catch(err => alert("Signup error: " + err.message));
  };

  window.login = function () {
    const email = document.getElementById("loginEmail").value.trim();
    const password = document.getElementById("loginPassword").value.trim();
    if (!email || !password) return alert("Please enter email and password.");
    signInWithEmailAndPassword(auth, email, password)
      .then(async userCred => {
        currentUser = userCred.user;
        const uid = currentUser.uid;
        const snap = await get(ref(db, 'users/' + uid));
        if (snap.exists()) {
          const nickname = snap.val().nickname || "User";
          document.getElementById("userNickname").innerText = "Hi, " + nickname;
          document.getElementById("auth").style.display = "none";
          document.getElementById("chatUI").style.display = "flex";
          loadFriendList();
        }
      })
      .catch(err => alert("Login error: " + err.message));
  };

  window.logout = function () {
    signOut(auth).then(() => location.reload());
  };

  window.addFriend = function () {
    const friendEmail = document.getElementById("friendEmail").value.trim();
    if (!friendEmail) return alert("Enter friend's email");
    get(ref(db, 'users')).then(snapshot => {
      let found = false;
      snapshot.forEach(child => {
        const data = child.val();
        if (data.email === friendEmail) {
          found = true;
          const friendUID = child.key;
          if (!data.nickname) {
            alert("This user has no nickname.");
            return;
          }
          // Prevent adding self as friend
          if (friendUID === currentUser.uid) {
            alert("You cannot add yourself as a friend.");
            return;
          }
          // Check if already friends
          get(ref(db, 'friends/' + currentUser.uid + '/' + friendUID)).then(friendSnap => {
            if (friendSnap.exists()) {
              alert("This user is already your friend!");
            } else {
              set(ref(db, 'friends/' + currentUser.uid + '/' + friendUID), {
                uid: friendUID,
                email: data.email,
                nickname: data.nickname
              });
              alert("Friend added!");
              loadFriendList();
            }
          });
        }
      });
      if (!found) alert("Friend not found.");
    });
  };

  function loadFriendList() {
    const list = document.getElementById("friendList");
    list.innerHTML = "";
    get(ref(db, 'friends/' + currentUser.uid)).then(snapshot => {
      if (snapshot.exists()) {
        snapshot.forEach(child => {
          const f = child.val();
          const div = document.createElement("div");
          div.className = "friend";
          div.innerHTML = `<i class="fas fa-user-circle"></i> ${f.nickname || "Friend"}`; // Add icon
          div.onclick = () => startChat(f.uid, f.nickname || "Friend");
          list.appendChild(div);
        });
      }
    });
  }

  window.searchFriend = function () {
    const searchEmail = document.getElementById("searchEmail").value.trim();
    if (!searchEmail) return alert("Enter email to search.");
    get(ref(db, 'friends/' + currentUser.uid)).then(snapshot => {
      let found = false;
      snapshot.forEach(child => {
        const data = child.val();
        if (data.email === searchEmail) {
          found = true;
          startChat(data.uid, data.nickname);
          // Hide sidebar on mobile after starting chat
          if (window.innerWidth <= 768) {
            toggleSidebar();
          }
        }
      });
      if (!found) alert("User not in your friend list.");
    });
  };

  function startChat(friendUID, nickname) {
    currentChatUID = friendUID;
    document.getElementById("chatWith").innerText = nickname;
    const chatId = getChatID(currentUser.uid, friendUID);
    const messagesRef = ref(db, 'messages/' + chatId);
    document.getElementById("messages").innerHTML = ""; // Clear previous messages

    // Listen for new messages
    onChildAdded(messagesRef, snapshot => {
      const msg = snapshot.val();
      const div = document.createElement("div");
      div.className = "bubble " + (msg.sender === currentUser.uid ? "sent" : "received");
      div.innerText = msg.text;
      document.getElementById("messages").appendChild(div);
      // Scroll to bottom
      document.getElementById("messages").scrollTop = document.getElementById("messages").scrollHeight;
    });
  }

  window.sendMessage = function () {
    const msgInput = document.getElementById("messageInput");
    const msg = msgInput.value.trim();
    if (!msg || !currentChatUID) return;
    const chatId = getChatID(currentUser.uid, currentChatUID);
    push(ref(db, 'messages/' + chatId), {
      sender: currentUser.uid, text: msg, timestamp: Date.now()
    });
    msgInput.value = ""; // Clear input field
  };

  function getChatID(uid1, uid2) {
    // Ensures a consistent chat ID regardless of sender/receiver order
    return uid1 < uid2 ? uid1 + "_" + uid2 : uid2 + "_" + uid1;
  }

  // Add event listener for Enter key on message input
  document.getElementById("messageInput").addEventListener("keypress", function(event) {
    if (event.key === "Enter") {
      event.preventDefault(); // Prevent default behavior (e.g., new line)
      sendMessage();
    }
  });

  // Initial display setup
  document.getElementById("auth").style.display = "flex"; // Use flex for auth container
</script>
</body>
</html>
